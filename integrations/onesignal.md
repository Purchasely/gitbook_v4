# OneSignal

## Why combine OneSignal and Purchasely?

### Pre-requisites

The minimal version of the Purchasely SDK supporting this integration is v3.2.0. If the Purchasely SDK integrated in your app is under the minimal version, please update it.

The OneSignal SDK also needs to be integrated inside the app.

### Subscription events

### General overview

[OneSignal](https://www.onesignal.com) is one of the leading customer engagement solutions for Push Notifications, Email, SMS & In-App.

This integration will allow you to get all Purchasely [subscription events](onesignal.md#subscription-events) to OneSignal making you able to trigger automated communication based on those events, messages that could be linked to a Purchasely powered paywall to engage, upsell, retain customers.

Purchasely provides a unified dataset to track the subscription events for all stores. These events are generated by the Purchasely Backend and your OneSignal users' can be updated accordingly.

![](<../.gitbook/assets/image (143).png>)

Subscription events generated by Purchasely will be sent to OneSignal using a server-to-server integration. As a result, you will be able to see all the subscription events in your OneSignal Dashboard and map them with your acquisition campaigns.

#### Events

The following events are the main ones that will trigger an udpate of your OneSignal users by Purchasely. See the full list [here](../analytics/events/webhook-events/subscription-events.md).

| Event                           | Description                                                                                                              |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------ |
| SUBSCRIPTION\_STARTED           | Sent when the user purchased a product wether it is the start of a trial or a regular purchase of a consumable product.  |
| SUBSCRIPTION\_RENEWED           | Sent when a subscription renews                                                                                          |
| SUBSCRIPTION\_EXPIRED           | Sent when the subscription actually ends                                                                                 |
| SUBSCRIPTION\_REACTIVATED       | Sent when an expired subscription is reactivated. This event is particularly useful for win-back & retargeting campaigns |
| SUBSCRIPTION\_REFUNDED\_REVOKED | Sent when the subscription actually ends                                                                                 |
| RENEWAL\_DISABLED               | Sent when the user deactivates the renewal of a subscription wether it is in trial period or not.                        |
| RENEWAL\_ENABLED                | Sent when the user reactivates                                                                                           |
| TRIAL\_STARTED                  | Sent when a trial starts                                                                                                 |
| TRIAL\_CONVERTED                | Sent when a user converts from a free trial to a normal paid-period                                                      |
| TRIAL\_NOT\_CONVERTED           | Sent when a user finishes it's trial period without renewing to a paid-period                                            |

#### Properties

The following properties are the main ones this integration can set and update in your OneSignal users as tags:

| Property                   | Description                                                                                                                                                                                                                                                                                                                                                   |
| -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| USER\_ID                   | Contains the user\_id that holds the purchase.                                                                                                                                                                                                                                                                                                                |
| PLAN                       | Contains the _Plan id_ that was bought.                                                                                                                                                                                                                                                                                                                       |
| SUBSCRIPTION\_STATUS       | <p>Filled for events that regards a subscription.</p><p>Possible Values :</p><ul><li><code>AUTO_RENEWING</code></li><li><code>ON_HOLD</code></li><li><code>IN_GRACE_PERIOD</code></li><li><code>AUTO_RENEWING_CANCELED</code></li><li><code>DEACTIVATED</code></li><li><code>REVOKED</code></li><li><code>PAUSED</code></li><li><code>UNPAID</code></li></ul> |
| STORE                      | <p>Contains the name of the Store through which the purchase was made.</p><p>Possible values:</p><ul><li><code>APPLE_APP_STORE</code></li><li><code>GOOGLE_PLAY_STORE</code></li><li><code>AMAZON_APPSTORE</code></li><li><code>HUAWEI_APPGALLERY</code></li></ul>                                                                                            |
| STORE\_COUNTRY             | Contains the store country where the purchase was made.                                                                                                                                                                                                                                                                                                       |
| PURCHASED\_AT              | Contains the date of the last transaction (original purchase or renewal).                                                                                                                                                                                                                                                                                     |
| NEXT\_RENEWAL\_AT          | Contains the next automatic renewal date\*\*.\*\*                                                                                                                                                                                                                                                                                                             |
| OFFER\_TYPE                | <p>Contains the current offer the subscription is under.</p><p>Possible values:</p><ul><li><code>NONE</code>: the user is paying the normal price, no offer associated</li><li><code>FREE_TRIAL</code></li><li><code>INTRO_OFFER</code></li><li><code>PROMO_CODE</code></li></ul>                                                                             |
| GRACE\_PERIOD\_EXPIRES\_AT | Contains the date when the grace period will end.                                                                                                                                                                                                                                                                                                             |
| LAST\_EVENT                | Name of the last event received for that subscription                                                                                                                                                                                                                                                                                                         |
| IS\_FAMILY\_SHARED         | Contains true or false depending on if the user has access to the subscription thanks to family sharing.                                                                                                                                                                                                                                                      |
| OFFER\_IDENTIFIER          | Contains the promo code used at the time of the purchase.                                                                                                                                                                                                                                                                                                     |
| ORIGINAL\_PURCHASED\_AT    | Contains the date of the first transaction.                                                                                                                                                                                                                                                                                                                   |

The properties' names set in OneSignal can be overriden when setting up the integration.

## **Integrating Purchasely with OneSignal**

The integration requires 2 steps:

1. Associate the user to events by providing the `OneSignal Player ID` to the Purchasely SDK
2. Activate the OneSignal integration in the Purchasely Console

### 1. Associating users to events

See the [OneSignal Documentation](https://documentation.onesignal.com/docs/sdk-reference#user-data) for more information

{% tabs %}
{% tab title="Swift" %}
```swift
if let oneSignalPlayerId = OneSignal.getDeviceState()?.userId {
	Purchasely.setAttribute(.oneSignalPlayerId, value: oneSignalPlayerId)
}
```
{% endtab %}

{% tab title="Kotlin" %}
```kotlin
OneSignal.getDeviceState()?.userId?.let {
	Purchasely.setAttribute(Attribute.ONESIGNAL_PLAYER_ID, it)
}
```
{% endtab %}

{% tab title="Java" %}
```java
Purchasely.setAttribute(Attribute.ONESIGNAL_PLAYER_ID, OneSignal.getDeviceState().getUserId());
```
{% endtab %}

{% tab title="React Native" %}
```jsx
var adid = OneSignal.getAdid();
Purchasely.setAttribute(Attributes.ONESIGNAL_PLAYER_ID, (await OneSignal.getDeviceState()).getUserId());
```
{% endtab %}
{% endtabs %}

***

### 2. Activating the OneSignal integration

The activation requires 2 steps:

1. Retrieving your app id and API key in the OneSignal Dashboard
2. Enabling the OneSignal integration in the Purchasely Console

#### a. Retrieving your app token and your app's API key in the OneSignal Dashboard

1. Log into your OneSignal dashboard: [https://app.onesignal.com/login](https://app.onesignal.com/login)
2. Access your App

![](<../.gitbook/assets/Screenshot 2022-03-30 at 22.49.19.png>)

3\. Got to your App's Settings

![](<../.gitbook/assets/Screenshot 2022-03-30 at 22.49.57.png>) ![](<../.gitbook/assets/Screenshot 2022-03-30 at 22.50.33.png>)

4\. Access the "Keys" submenu

![](<../.gitbook/assets/Screenshot 2022-03-30 at 22.52.04.png>)

5\. Your appâ€™s app id is beneath the `OneSignal App ID` title

6\. Your app's API key is beneath the `Rest API Key` title

#### b. Enabling the OneSignal integration in the Purchasely Console

1. Go in the "External integrations" section, and open the edition form for OneSignal:

![](<../.gitbook/assets/Screenshot 2022-03-30 at 23.04.40.png>)

2\. Enable the integration

3\. Set your OneSignal app id

4\. Set your OneSignal app API key

![](<../.gitbook/assets/Screenshot 2022-03-30 at 23.05.01.png>)

5\. Enable the properties you want to be set and updated as OneSignal `tags` for your users

6\. (Optional) Override the property names that will be used when updating your users' OneSignal `tags`

![](<../.gitbook/assets/Screenshot 2022-03-30 at 23.05.37.png>)

7\. Save

### Testing your integration

To test your integration, you can perform a set of in-app purchases in a Sandbox environment (eg: TestFlight for the App Store) and verify your user's `tags` are properly updated in the OneSignal dashboard ([https://app.onesignal.com/login](https://app.onesignal.com/login)).

{% hint style="info" %}
If testing using Automated Messages, bear in mind that OneSignal automated messages are sent roughly every 4-6 hours if you are on a free plan, and within a few minutes if you are on a paid plan.
{% endhint %}
